<!DOCTYPE html>
<html lang="en">
<script src="/socket.io/socket.io.js"></script>
<script>
    let socket = io();
</script>
<script src="static/functions/Crypto/crypto.js"></script>
<script src="static/functions/ECDH/ECDHE.js"></script>
<script src="static/functions/ECDH/SecGen.js"></script>
<script src="static/functions/ECDH/masterKey.js"></script>

<script src="https://bundle.run/buffer@6.0.3"></script>

<script src="static/functions/Crypto/chacha.js"></script>
<script src="static/functions/chacha/encrypt.js"></script>
<script src="static/functions/chacha/decrypt.js"></script>

<script src="static/functions/newDataHandler.js"></script>

<head>
    <meta charset="UTF-8">
    <title>Welcome to my Testing page</title>
</head>
<body>
Hello!
<div>
    <button class="button1" id="negotiate" type="button" onclick=socket.emit("Test")>Negotiate Cipher</button><br><br>
</div>
</body>

<script>
socket.on("ServKey", (SKey) => {
    console.log("keyExchange")
    socket.emit("PubKey", (ECDHE()));
    window.ServKey = SKey
    let secret = SecGen();
    window.mKey = masterKey(secret,"")
    //TODO add some method for identical derivation of a nonce for the MKEY, possibly server/client picks with AEAD channel
})
//handshake; check we can decrypt data, return "good-Conn" if true
socket.on("serverMessage", (eData) => {
    try{
        let message = decrypt(window.mKey, eData[0], eData[1], eData[2])
        message = message.toString().split("<SEPERATOR>")
        newDataHandler(message)
        socket.emit("Got Message")
    }
    catch{
        console.log("bad data")
        socket.emit("Bad-Conn")
    }
})
</script>
</html>

